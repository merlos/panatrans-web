"use strict";!function(){var a=L.Marker.prototype.onAdd;L.Marker.mergeOptions({bounceOnAdd:!1,bounceOnAddDuration:1e3,bounceOnAddHeight:-1}),L.Marker.include({_toPoint:function(a){return this._map.latLngToContainerPoint(a)},_toLatLng:function(a){return this._map.containerPointToLatLng(a)},_animate:function(a){var b=new Date,c=setInterval(function(){var d=new Date-b,e=d/a.duration;e>1&&(e=1);var f=a.delta(e);a.step(f),1===e&&(a.end(),clearInterval(c))},a.delay||10)},_move:function(a,b){var c=L.latLng(this._orig_latlng),d=this._drop_point.y,e=this._drop_point.x,f=this._point.y-d,g=this;this._animate({delay:10,duration:b||1e3,delta:a,step:function(a){g._drop_point.y=d+f*a-(g._map.project(g._map.getCenter()).y-g._orig_map_center.y),g._drop_point.x=e-(g._map.project(g._map.getCenter()).x-g._orig_map_center.x),g.setLatLng(g._toLatLng(g._drop_point))},end:function(){g.setLatLng(c)}})},_easeOutBounce:function(a){return 1/2.75>a?7.5625*a*a:2/2.75>a?7.5625*(a-=1.5/2.75)*a+.75:2.5/2.75>a?7.5625*(a-=2.25/2.75)*a+.9375:7.5625*(a-=2.625/2.75)*a+.984375},bounce:function(a,b){this._orig_map_center=this._map.project(this._map.getCenter()),this._drop_point=this._getDropPoint(b),this._move(this._easeOutBounce,a)},_getDropPoint:function(a){this._point=this._toPoint(this._orig_latlng);var b;return b=void 0===a||0>a?this._toPoint(this._map.getBounds()._northEast).y:this._point.y-a,new L.Point(this._point.x,b)},onAdd:function(b){this._map=b,this._orig_latlng=this._latlng,this.options.bounceOnAdd===!0&&(this._drop_point=this._getDropPoint(this.options.bounceOnAddHeight),this.setLatLng(this._toLatLng(this._drop_point))),a.call(this,b),this.options.bounceOnAdd===!0&&this.bounce(this.options.bounceOnAddDuration,this.options.bounceOnAddHeight)}})}();var _CONFIG={};_CONFIG.serverUrl="http://api.panatrans.org",_CONFIG.tilelayerUrl="http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",_CONFIG.tilelayerAttribution='&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',_CONFIG.delay="",$(".navbar .navbar-link").click(function(){var a=$(".navbar-toggle");a.is(":visible")&&a.trigger("click")}),angular.module("panatransWebApp",["ngAnimate","ngCookies","ngMessages","ngResource","ngRoute","ngTouch","ui.bootstrap","ui.sortable","angular-toArrayFilter","ngToast","slugifier"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/rutas",{templateUrl:"views/routes.html",controller:"RoutesCtrl"}).when("/metrobus/:routeId/:slug.html",{templateUrl:"views/routes-show.html",controller:"RoutesShowCtrl"}).when("/colabora",{templateUrl:"views/contribute.html",controller:"ContributeCtrl"}).when("/acercade",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/licencias",{templateUrl:"views/licenses.html",controller:"LicensesCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("panatransWebApp").config(["ngToastProvider",function(a){a.configure({verticalPosition:"top",horizontalPosition:"center",maxNumber:3})}]),angular.module("panatransWebApp").controller("MainCtrl",["$scope","$compile","$http","$modal","ngToast",function(a,b,c,d,e){if(!a.map){{(function(){var a=!1;return function(b){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(b)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(b.substr(0,4)))&&(a=!0)}(navigator.userAgent||navigator.vendor||window.opera),a})()}a.routes={},a.stops={},a.stopsArr={},a.showStopDetail=!1,a.loadingStopDetail=!1,a.stopDetail={};var f=null,g=null,h={},i=null,j=null,k={},l={},m={"default":L.AwesomeMarkers.icon({icon:"bus",prefix:"fa",markerColor:"blue"}),orange:L.AwesomeMarkers.icon({icon:"bus",prefix:"fa",markerColor:"orange"}),orangeSpin:L.AwesomeMarkers.icon({icon:"bus",prefix:"fa",markerColor:"orange",spin:!0}),pink:L.AwesomeMarkers.icon({icon:"bus",prefix:"fa",markerColor:"pink"}),red:L.AwesomeMarkers.icon({icon:"bus",prefix:"fa",markerColor:"red"}),redSpin:L.AwesomeMarkers.icon({icon:"bus",prefix:"fa",markerColor:"red",spin:!0}),userLocation:L.AwesomeMarkers.icon({icon:"user",prefix:"fa",markerColor:"green",spin:!1})};a.map=L.map("map",{center:[8.9740946,-79.5508536],zoom:16,zoomControl:!1}),L.tileLayer(_CONFIG.tilelayerUrl,{attribution:_CONFIG.tilelayerAttribution,maxZoom:18}).addTo(a.map),a.map.setZoom(16),c.get(_CONFIG.serverUrl+"/v1/routes?with_trips=true"+_CONFIG.delay).success(function(b){a.routesArray=b.data,$.each(b.data,function(b,c){a.routes[c.id]=c})});var n=function(b){var c=L.marker([b.lat,b.lon],{icon:m["default"],draggable:!1,title:b.name});c.addTo(a.map).bindPopup(b.name),c.on("popupopen",v),c.on("popupclose",x),c._stopId=b.id,k[b.id]=c};c.get(_CONFIG.serverUrl+"/v1/stops/?"+_CONFIG.delay).success(function(b){console.log("Success getting stops. number of stops: "+b.data.length),a.stopsArr=b.data,$.each(b.data,function(b,c){a.stops[c.id]=c,n(c)})});var o=function(b){if(null!==b.accuracy){var c=b.accuracy/2;null===f&&(f=L.marker(b.latlng,{icon:m.userLocation}),f.addTo(a.map),a.map.panTo(b.latlng),g=L.circle(b.latlng,c),g.addTo(a.map)),f.setLatLng(b.latlng),f.bindPopup("Estás cerca de este punto en un radio de unos "+c+" metros."),g.setLatLng(b.latlng),g.setRadius(c),a.trackingUser&&a.map.panTo(b.latlng)}},p=function(a){console.log(a.message)},q=function(){var b=a.map.getBounds().pad(.2);angular.forEach(k,function(c){b.contains(c.getLatLng())||a.map.removeLayer(c)})},r=function(){var b=a.map.getBounds().pad(.2);console.log("bounds:"),console.log(b),angular.forEach(a.stops,function(c,d){b.contains(k[d].getLatLng())&&(a.map.addLayer(k[d]),console.log("adding marker key:"+d))})},s=!0,t=function(){if(console.log("onZoomEnd"),console.log("zoomLevel: "+a.map.getZoom()),a.map.getZoom()<15)console.log("deleting all markers from map"),angular.forEach(k,function(b){a.map.removeLayer(b)}),s=!1;else{if(s)return;r(),s=!0}},u=function(){console.log("onMoveEnd"),a.map.getZoom()>=15&&(q(),r())};a.map.on("locationfound",o),a.map.on("locationerror",p),a.map.locate({watch:!0,setView:!1,enableHighAccuracy:!0}),a.map.on("zoomend",t),a.map.on("moveend",u);var v=function(a){console.log("stopMarkerPopupOpen"),console.log(j),null===j&&w(a)},w=function(b){console.log("popupOpen - stopMarkerClicked"),a.showStopDetail=!0,console.log(b);var d=b.popup._source._stopId;return null===d?void console.log("stopMarkerClicked: Hey! Hey! stopId es null :-?"):(console.log("stopId Clicked: "+d),a.map.panTo(k[d].getLatLng()),void(a.stops[d].routes?a.$apply(function(){a.stopDetail=a.stops[d],z(d)}):(k[d].setIcon(m.orangeSpin),a.loadingStopDetail=!0,c.get(_CONFIG.serverUrl+"/v1/stops/"+d+"?with_stop_sequences=true"+_CONFIG.delay).success(function(b){a.loadingStopDetail=!1,console.log("Success getting stop info"),console.log(b.data),a.stopDetail=b.data,a.stops[a.stopDetail.id]=b.data,z(d)}))))},x=function(){console.log("stopMarkerClosed"),null===j&&$.each(k,function(a,b){b.setIcon(m["default"])})};a.closeStopDetail=function(){a.showStopDetail=!1},a.isFirstStopInTrip=function(a,b){var c=!1;return $.each(b.stop_sequences,function(b,d){0===d.sequence&&d.stop_id===a.id&&(c=!0)}),c},a.isLastStopInTrip=function(a,b){var c=-1,d=-1;return $.each(b.stop_sequences,function(a,b){b.sequence>c&&(c=b.sequence,d=b.stop_id)}),d===a.id?!0:!1},a.highlightStop=function(b){console.log("highlight stop"+b.name),j=b,k[b.id].openPopup(),a.map.panTo(k[b.id].getLatLng())},a.lowlightStop=function(b){console.log("loglight stop"+b.name),k[a.stopDetail.id].openPopup(),j=null};var y=function(a,b){$.each(a.trips,function(a,c){$.each(c.stop_sequences,function(a,c){k[c.stop_id].setIcon(b)})})},z=function(b){$.each(a.stopDetail.routes,function(a,b){y(b,m.orange)}),k[b].setIcon(m.red)};a.highlightRoute=function(a){console.log("highlight route "+a.name),y(a,m.red)},a.lowlightRoute=function(b){y(b,m.orange),k[a.stopDetail.id].setIcon(m.red)},a.hoverIn=function(){this.hoverEdit=!0},a.hoverOut=function(){this.hoverEdit=!1},a.toggleTripDetails=function(){console.log("toggle"),this.showTripDetails=this.showTripDetails===!1||void 0===this.showTripDetails?!0:!1,console.log("showTripDetails: "+this.showTripDetails)},a.openEditStopModal=function(b){var c=d.open({templateUrl:"views/modals/edit-stop.html",size:"lg",controller:"EditStopModalInstanceCtrl",backdrop:!0,stopId:b,resolve:{routes:function(){return a.routesArray},stop:function(){return a.stopDetail}}});c.result.then(function(){},function(c){console.log("modal instance dismissed reason : "+c),"changeStopLocation"===c&&(console.log("changeStopLocation: "+b),A(k[b])),"stopDeleted"===c&&(console.log("deletedStop, eliminating marker and stop"),a.map.removeLayer(k[b]),e.create("Se ha borrado la parada "+a.stops[b].name),delete k[b],delete a.stops[b])})},a.togglePdfLayer=function(b){var d="https://dl.dropboxusercontent.com/u/22698/metrobus/";c.get(d+b.id+"/kml/tilemapresource.xml").success(function(){if(console.log("cool! The pdf is geolocated route_id:"+b.id),void 0===l[b.id]){var c={minZoom:11,maxZoom:18,maxNativeZoom:14,opacity:.8,tms:!0},f=d+b.id+"/kml/{z}/{x}/{y}.png";console.log("tilesUrl: "+f),l[b.id]=L.tileLayer(f,c),l[b.id].addTo(a.map),e.create("En unos segundos se mostrará el PDF de la ruta en el mapa...")}else a.map.removeLayer(l[b.id]),delete l[b.id],e.create({className:"info",contents:"Se ha dejado de mostrar el PDF en el mapa"})}).error(function(a,b){console.log(a),console.log(b),console.log("Geolocated pdf does not exists"),e.create({className:"danger",contents:"No hay asociado con esta ruta un PDF Geolocalizado"})})};var A=function(c){console.log("setStopMarkerEditMode"),c.setIcon(m.redSpin),c.dragging.disable(),c.dragging.enable(),c.off("popupopen",v),c.off("popupclose",x),a.map.setView(c.getLatLng(),18);var d=a.stops[c._stopId],e="<div><h4>"+d.name+'</h4><p><strong>Arrástrame</strong> hasta mi localización.<br>Después dale a: </p><button ng-click="saveStopLocation(stop)"class="btn btn-primary">Actualizar</button> o a <a href="" ng-click="cancelStopMarkerEditMode(stopMarker)">cancelar</a></div>',f=b(angular.element(e)),g=a.$new();g.stop=d,g.stopMarker=c;var h=f(g);console.log(h),c.bindPopup(h[0]).openPopup(),c.on("dragend",function(b){console.log("dragend called!!");var c=b.target;c.openPopup();var e=c.getLatLng();d.lat=e.lat,d.lon=e.lng,console.log(a.newStop)})};a.cancelStopMarkerEditMode=function(b){console.log("cancelStopMarkerEditMode"),b.closePopup(),b.dragging.disable(),b.setIcon(m.red),console.log("setting popup content = "+a.stops[b._stopId].name),b.bindPopup(a.stops[b._stopId].name),b.on("popupopen",v),b.on("popupclose",x),b.openPopup()},a.saveStopLocation=function(b){console.log("saveStopLocation called"),c.put(_CONFIG.serverUrl+"/v1/stops/"+b.id,{stop:{lat:b.lat,lon:b.lon}}).success(function(){console.log("new stop location successfully saved"),a.cancelStopMarkerEditMode(k[b.id])}).error(function(a){console.log("error updating stop Location"),console.log(a)})},a.openEditRouteModal=function(b){var c={templateUrl:"views/modals/edit-route.html",size:"lg",controller:"EditRouteModalInstanceCtrl",backdrop:!0,routeId:b,resolve:{route:function(){return a.routes[b]},stopsArr:function(){return a.stopsArr}}};d.open(c)},a.openNewRouteModal=function(){var a={templateUrl:"views/modals/new-route.html",controller:"NewRouteModalInstanceCtrl",backdrop:"static",resolve:{}};d.open(a)},a.saveNewStop=function(){console.log("saveSaveNewStop"),console.log(h),c.post(_CONFIG.serverUrl+"/v1/stops/",{stop:h}).success(function(b){console.log("stop saved successfully"),console.log(b.data),a.stops[b.data.id]=b.data,a.stopDetail=b.data,i._stopId=b.data.id,i.closePopup(),i.setIcon(m["default"]),i.bindPopup(b.data.name),i.on("popupopen",v),i.on("popupclose",x),k[b.data.id]=i,i.openPopup(),h={},i=null,e.create("Excelente, ¡parada añadida!"),console.log("Se ha añadido la parada con éxito")}).error(function(a){console.log(a)})},a.cancelSaveNewStop=function(){console.log("cancelSaveStop")},a.openNewStopModal=function(){var c={templateUrl:"views/modals/new-stop.html",controller:"NewStopModalInstanceCtrl",backdrop:"static",resolve:{}},e=d.open(c);e.result.then(function(c){h=c;var d=a.map.getCenter();h.lat=d.lat,h.lon=d.lng,i=L.marker(d,{icon:m.redSpin,draggable:!0,bounceOnAdd:!0,bounceOnAddOptions:{duration:500,height:100},bounceOnAddCallback:function(){console.log("bouncing done")}}).addTo(a.map);var e="<div><h4>"+h.name+'</h4><p><strong>Arrástrame</strong> hasta mi localización.<br>Después dale a: </p><button ng-click="saveNewStop()"class="btn btn-primary">Guardar</button> o <a ng-click="cancelSaveNewStop()">cancelar</a></div>',f=b(angular.element(e)),g=a.$new(),j=f(g);console.log(j),i.bindPopup(j[0]).openPopup(),i.on("dragend",function(b){console.log("dragend called!!");var c=b.target;c.openPopup();var d=c.getLatLng();h.lat=d.lat,h.lon=d.lng,console.log(a.newStop)})},function(){})}}}]),angular.module("panatransWebApp").controller("AboutCtrl",["$scope",function(a){a.title="Acerca de",window.scrollTo(0,0)}]),angular.module("panatransWebApp").controller("LicensesCtrl",["$scope",function(a){a.title="Licenses",window.scrollTo(0,0)}]),angular.module("panatransWebApp").controller("RoutesCtrl",["$scope","$http","$modal","ngToast",function(a,b,c,d){a.routes={},a.stopsArr=[],a.stops={},a.loading=!0,console.log("requesting routes..."),b.get(_CONFIG.serverUrl+"/v1/routes/?with_trips=true").success(function(b){a.loading=!1,a.routesArray=b.data,$.each(b.data,function(b,c){a.routes[c.id]=c})}).error(function(a,b){console.log("error obteniendo rutas"),0===b&&d.create({className:"danger",contents:"¡Ups! El servidor parece caído. Prueba en un rato Si sigue así contáctanos en @panatrans"}),422!==b&&(d.create({className:"danger",contents:"Error accediendo al servidor. Prueba en un rato. Si el problema persiste contacta por twitter: @panatrans"}),console.log(a))}),b.get(_CONFIG.serverUrl+"/v1/stops/?"+_CONFIG.delay).success(function(b){console.log("Success getting stops!!!"),a.stopsArr=b.data,$.each(b.data,function(b,c){a.stops[c.id]=c})}),a.ignoreAccentsComparator=function(a,b){var c=function(a){return a.replace(/á/g,"a").replace(/é/g,"e").replace(/í/g,"i").replace(/ó/g,"o").replace(/ú/g,"u").replace(/\-/g,"").replace(/\s/g,"")};return"string"!=typeof a?!1:b?(a=c(a.toLowerCase()),b=c(b.toLowerCase()),a.indexOf(b)>-1):!0},a.openEditRouteModal=function(b){var d={templateUrl:"views/modals/edit-route.html",size:"lg",controller:"EditRouteModalInstanceCtrl",backdrop:!0,routeId:b,resolve:{route:function(){return a.routes[b]||null},stopsArr:function(){return a.stopsArr}}},e=c.open(d);e.result.then(function(){},function(c){console.log("modal instance dismissed reason : "+c),"routeDeleted"===c&&(console.log("routeDeleted: "+b),delete a.routes[b])})}}]),angular.module("panatransWebApp").controller("RoutesShowCtrl",["$scope","$http","$modal","ngToast","$routeParams",function(a,b,c,d,e){a.route={},console.log(e),a.loading=!0;var f={},g=null,h={};if(!a.map){a.map=L.map("route-map",{center:[8.9740946,-79.5508536],zoom:16,zoomControl:!1}),L.tileLayer(_CONFIG.tilelayerUrl,{attribution:_CONFIG.tilelayerAttribution,maxZoom:18}).addTo(a.map);var i={"default":L.AwesomeMarkers.icon({icon:"bus",prefix:"fa",markerColor:"blue"}),red:L.AwesomeMarkers.icon({icon:"bus",prefix:"fa",markerColor:"red"})},j=function(b){var c=L.marker([b.lat,b.lon],{icon:i["default"],draggable:!1,title:b.name});c.bindPopup(b.name),c.on("popupopen",k),c.on("popupclose",l),c._stopId=b.id,f[b.id]=c,null===g&&(g=L.featureGroup(),g.addTo(a.map)),g.addLayer(c)},k=function(a){var b=a.popup._source._stopId;return null===b?void console.log("stopMarkerClicked: Hey! Hey! stopId es null :-?"):void f[b].setIcon(i.red)},l=function(a){var b=a.popup._source._stopId;return null===b?void console.log("stopMarkerPopupClose: Hey! Hey! stopId es null :-?"):void f[b].setIcon(i["default"])};a.highlightStop=function(b){f[b.id].openPopup(),a.map.panTo(f[b.id].getLatLng())},a.lowlightStop=function(a){console.log("loglight stop"+a.name),f[a.id].closePopup()};var m={};a.togglePdfLayer=function(c){console.log("togglePDFLayer");var e="https://dl.dropboxusercontent.com/u/22698/metrobus/";b.get(e+c.id+"/kml/tilemapresource.xml").success(function(b){console.log(b);var f=b.match(/(minx|miny|maxx|maxy)=\"([\-\.\d]+)\"/g);if(console.log(f),angular.forEach(f,function(a,b){f[b]=a.match(/([\-\.\d]+)/g)[0]}),a.map.fitBounds([[f[1],f[0]],[f[3],f[2]]]),console.log(f),console.log("cool! The pdf is geolocated route_id:"+c.id),void 0===m[c.id]){var g={minZoom:11,maxZoom:18,maxNativeZoom:14,opacity:.8,tms:!0},h=e+c.id+"/kml/{z}/{x}/{y}.png";console.log("tilesUrl: "+h),m[c.id]=L.tileLayer(h,g),m[c.id].addTo(a.map),d.create("En unos segundos se mostrará el PDF de la ruta en el mapa...")}else a.map.removeLayer(m[c.id]),delete m[c.id],d.create({className:"info",contents:"Se ha dejado de mostrar el PDF en el mapa"})}).error(function(a,b){console.log("Geolocated pdf does not exists"),console.log(a),console.log(b),d.create({className:"danger",contents:"No hay asociado con esta ruta un PDF Geolocalizado"})})},b.get(_CONFIG.serverUrl+"/v1/routes/"+e.routeId+"?"+_CONFIG.delay).success(function(b){a.route=b.data,a.loading=!1,console.log(a.route),angular.forEach(a.route.trips,function(a){angular.forEach(a.stop_sequences,function(a){var b=a.stop;void 0===h[b.id]&&(j(b),h[b.id]=b)})}),g&&a.map.fitBounds(g.getBounds(),{padding:[15,15]})}).error(function(a){console.log("WTF! Something wrong with the route!"),console.log(a)}),a.openEditRouteModal=function(b){var d={templateUrl:"views/modals/edit-route.html",size:"lg",controller:"EditRouteModalInstanceCtrl",backdrop:!0,routeId:b,resolve:{route:function(){return a.route},stopsArr:function(){return null}}};c.open(d)}}}]),angular.module("panatransWebApp").controller("ContributeCtrl",["$scope",function(a){a.title="Colabora",window.scrollTo(0,0)}]),angular.module("panatransWebApp").controller("EditRouteModalInstanceCtrl",["$scope","$http","ngToast","$modalInstance","route","stopsArr",function(a,b,c,d,e,f){a.sortedStopSequences={},a.unknownStopSequences={},a.isNewRoute=!1,a.loading=!0,a.route=e;var g=angular.copy(e);a.showNewStopSequence={},a.newStopSequence={},a.dragControlListeners={};var h=function(){b.get(_CONFIG.serverUrl+"/v1/routes/"+a.route.id+"?"+_CONFIG.delay).success(function(b){a.route=b.data,g=angular.copy(b.data),a.loading=!1,$.each(a.route.trips,function(b,c){a.sortedStopSequences[c.id]=[],a.unknownStopSequences[c.id]=[],$.each(c.stop_sequences,function(b,d){null!==d.sequence?a.sortedStopSequences[c.id].push(d):a.unknownStopSequences[c.id].push(d)})})}).error(function(a){console.log("WTF! Something wrong with the route!"),console.log(a)})};null==f?(console.log("requesting stops to server..."),b.get(_CONFIG.serverUrl+"/v1/stops/?"+_CONFIG.delay).success(function(b){a.stopsArr=b.data})):a.stopsArr=f,null==e&&(e={trips:[]},a.route=e,a.isNewRoute=!0,a.loading=!1),$.each(e.trips,function(c,d){a.newStopSequence[d.id]={stop:null,trip:d,sequence:null},a.dragControlListeners[d.id]={},$.each(["sorted","unknown"],function(c,e){console.log(e+" -------"+d.id),a.dragControlListeners[d.id][e]={accept:function(){return!0},itemMoved:function(a){console.log("source sort"+e),console.log("source trip.id"+d.id),console.log("itemMoved"),console.log(a),console.log("nueva posición: "+a.dest.index),console.log("dest trip:"+a.dest.sortableScope.$parent.trip.id),console.log("src seq:"+a.source.itemScope.modelValue.sequence),console.log("dest sortStatus"+a.dest.sortableScope.options.containment.indexOf("unknown"));var c,f=a.dest.sortableScope.$parent.trip,g=a.source.itemScope.modelValue;f.id===d.id?null===g.sequence?(g.sequence=a.dest.index,c={stop_sequence:{sequence:a.dest.index}}):(g.sequence=null,c={stop_sequence:{unknown_sequence:!0}}):0===a.dest.sortableScope.options.containment.indexOf("unknown")?(g.sequence=null,c={stop_sequence:{unknown_sequence:!0,trip_id:f.id}}):(g.trip=f,g.sequence=a.dest.index,c={stop_sequence:{sequence:a.dest.index,trip_id:f.id}}),console.log("putData"),console.log(g),b.put(_CONFIG.serverUrl+"/v1/stop_sequences/"+g.id,c).success(function(){h()})},orderChanged:function(a){if(console.log("orderChanged "),console.log("nueva posición: "+a.dest.index),console.log(a),0!==a.dest.sortableScope.options.containment.indexOf("unknown")){var c=a.dest.index,d=a.source.itemScope.modelValue;console.log("nueva posición: "+a.dest.index);var e={stop_sequence:{sequence:c}};b.put(_CONFIG.serverUrl+"/v1/stop_sequences/"+d.id,e).success(function(){console.log("updated stop sequence!"),h()})}},containment:e+"_"+d.id}})}),console.log(a.dragControlListeners),e.trips.length>0&&e.trips[0].stops?a.loading=!1:a.isNewRoute||h(),a.addNewRoute=function(){console.log("add new Route"),b.post(_CONFIG.serverUrl+"/v1/routes/",{route:{name:a.route.name}}).success(function(b){c.create("Ruta creada. Ahora sigue completando la información"),console.log("route successfully created"),a.route=b.data,a.serverRoute=angular.copy(e),a.isNewRoute=!1}).error(function(a,b){var d=a.errors.name.join(", ")||"";c.create({className:"danger",contents:"Error: "+d}),console.log(a),console.log(b),console.log("Error creating route")})},a.deleteRoute=function(){console.log("delete route"),b["delete"](_CONFIG.serverUrl+"/v1/routes/"+a.route.id).success(function(){c.create("Ruta eliminada"),d.dismiss("routeDeleted")}).error(function(a,b){var d=a.errors.name.join(", ")||"";c.create({className:"danger",contents:"Error: "+d}),console.log(a),console.log(b),console.log("Error deleting route")})},a.updateRouteName=function(){a.isNewRoute||(console.log("updateRouteName"),a.route.name!==g.name&&b.put(_CONFIG.serverUrl+"/v1/routes/"+a.route.id,{route:{name:a.route.name}}).success(function(){c.create("Se ha actualizado el nombre de la ruta"),console.log("route name successfully updated")}).error(function(a,b){var d=a.errors.name.join(", ")||"";c.create({className:"danger",contents:"Error: "+d}),console.log(a),console.log(b),console.log("Error updating route name")}))},a.updateRouteUrl=function(){console.log("updateRouteUrl"),a.route.url!==g.url&&b.put(_CONFIG.serverUrl+"/v1/routes/"+a.route.id,{route:{url:a.route.url}}).success(function(){c.create("Se ha actualizado la dirección web"),console.log("route name successfully updated")}).error(function(){c.create({className:"danger",contents:"Error: "+errors}),console.log(data),console.log(status),console.log("error updating route")})},a.deleteStopSequence=function(a){b["delete"](_CONFIG.serverUrl+"/v1/stop_sequences/"+a.id).success(function(){c.create("Se eliminado la parada del trayecto"),console.log("removed stop sequence success!"),h()})};var i=function(a,b){var c=/transfer|tranfer|corredor|circular/i,d=b.split("-"),e=!1,f=!1;switch(angular.forEach(d,function(a,b){var g=d[b].trim();g.match(c)||(e?f=g:e=g)}),a){case"one":return[f];case"circular":return["circular"];case"two":return[f,e];default:return void 0}};a.routeHasTrips=function(){return void 0!==a.route.trips&&0!==a.route.trips.length},a.addTripsToRoute=function(){console.log("addTripsToRoute. tripsType:"+a.route.tripsType),console.log(i(a.route.tripsType,a.route.name));var d=i(a.route.tripsType,a.route.name);if(void 0===d)return void c({className:"danger",contents:"Error. Revisa que el nombre de la ruta tenga el formato adecuado."});var e=0;angular.forEach(d,function(f,g){console.log(f),console.log(g);var i={headsign:f,direction:g,route_id:a.route.id};b.post(_CONFIG.serverUrl+"/v1/trips/",{trip:i}).success(function(a){console.log("added trips to route"),c.create("Se ha añadido el trayecto "+a.data.headsign),++e===d.length&&h()}).error(function(a,b){console.log("error updating trip"),console.log(a.errors),console.log(b),422!=b&&c("Humm! Error raro. Si el error persiste, probablemente tengas que contactar con los administradores");var e="";c.create("Hubo problema a al añadir el trayecto: "+e),++response===d.length&&h()})})},a.deleteTrips=function(){console.log("deleteTrips. number to delete = "+a.route.trips.length);var d=0;angular.forEach(a.route.trips,function(e){b["delete"](_CONFIG.serverUrl+"/v1/trips/"+e.id).success(function(){++d===a.route.trips.length&&h()}).error(function(b,d){console.log("error updating trip"),console.log(b.errors),console.log(d),422!=d&&c("Humm! Error raro. Si el error persiste, probablemente tengas que contactar con los administradores");var e="";c.create("Hubo problema al borrar los trayectos: "+e),++response===a.route.trips.length&&h()})})},a.tripsHaveStops=function(){var b=!1;return angular.forEach(a.route.trips,function(a){void 0!==a.stop_sequences&&a.stop_sequences.length>0&&(b=!0)}),b},a.addStopToTrip=function(d){var e=!1;console.log("stopSequence:"+a.newStopSequence[d].sequence),-1===a.newStopSequence[d].sequence&&(e=!0);var f={stop_sequence:{sequence:a.newStopSequence[d].sequence,unknown_sequence:e,stop_id:a.newStopSequence[d].stop.id,trip_id:d}};console.log("addStopToTrip postData:"),console.log(f),b.post(_CONFIG.serverUrl+"/v1/stop_sequences/",f).success(function(){h(),c.create("Se ha añadido la parada al trayecto."),a.showNewStopSequence[d]=!0,a.newStopSequence[d].stop=null})},a.close=function(){d.close()}}]),angular.module("panatransWebApp").controller("EditStopModalInstanceCtrl",["$scope","$http","$modalInstance","ngToast","routes","stop",function(a,b,c,d,e,f){a.stop=f,a.routes=e,console.log(e),a.tripNotAlready=function(b){var c=!0;return $.each(a.stop.routes,function(a,d){$.each(d.trips,function(a,d){d.id===b.id&&(c=!1)})}),c},a.searchFilter=function(b){var c=new RegExp(a.searchText,"i");return!a.searchText||c.test(b.name)},a.addTrip=function(c){console.log("addTrip: "+c),b.post(_CONFIG.serverUrl+"/v1/stop_sequences/",{stop_sequence:{unknown_sequence:!0,stop_id:a.stop.id,trip_id:c}}).success(function(b){console.log("added trip to stop"),console.log(b);var c=b.data.trip,d=!1;if($.each(a.stop.routes,function(b,e){e.id===c.route.id&&(d=!0,a.stop.routes[b].trips.push(c))}),!d){var e=c.route;e.trips=[c],a.stop.routes.push(e)}}).error(function(a){console.log("error adding trip to stop"),console.log(a)})},a.updateStopName=function(){console.log("updateStop"),console.log(a.stop),b.put(_CONFIG.serverUrl+"/v1/stops/"+a.stop.id,{stop:{name:a.stop.name}}).success(function(){console.log("Stop successfully updated"),d.create("Nombre de la parada actualizado con éxito.")}).error(function(a){console.log("error adding trip to stop"),console.log(a)})},a.deleteStop=function(){return a.stop.routes.length>0?(console.log("ERROR: the stop has trips cannot be deleted"),void alert("No se puede borrar. Tienes que quitar todas las rutas que pasan por la parada antes de eliminarla.")):void b["delete"](_CONFIG.serverUrl+"/v1/stops/"+a.stop.id).success(function(){d.create("Parada eliminada."),console.log("parada borrada del servidor con éxito"),c.dismiss("stopDeleted")}).error(function(a){console.log("Error borrando la parada"),console.log(a)})},a.changeStopLocation=function(){console.log("changeStopLocation Requested"),c.dismiss("changeStopLocation")},a.deleteTrip=function(c){b["delete"](_CONFIG.serverUrl+"/v1/stop_sequences/trip/"+c+"/stop/"+a.stop.id).success(function(b){console.log(b),console.log("awesome! Trip and stop unlinked"),$.each(a.stop.routes,function(b,d){$.each(d.trips,function(d,e){e.id===c&&(a.stop.routes[b].trips.splice(d,1),0===a.stop.routes[b].trips.length&&a.stop.routes.splice(b,1))})}),d.create("Se ha eliminado la parada del trayecto.")}).error(function(a){console.log("error removing trip from stop"),console.log(a)})},a.close=function(){c.close()}}]),angular.module("panatransWebApp").controller("NewRouteModalInstanceCtrl",["$scope","$modalInstance",function(a,b){a.ok=function(){b.close(a.selected.item)},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("panatransWebApp").controller("NewStopModalInstanceCtrl",["$scope","$modalInstance",function(a,b){a.stop={},a.ok=function(){b.close(a.stop)},a.cancel=function(){b.dismiss("cancel")}}]);
